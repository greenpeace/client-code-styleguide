/**!
 * @name p3-styleguide
 * @version v0.3.0
 * @date 2013-11-22
 * @copyright Copyright 2013, Greenpeace International
 * @license MIT License (opensource.org/licenses/MIT)
 */
"use strict";!function(a,b){var c=a.p3||{},d={delimiter:"|"};c.autofill=function(c,e){var f=a(c),g=a.extend(!0,d,e),h=b.location.href.split("#")[0];a.each(a.p3.request(h).parameters,function(b,c){if(c.indexOf(g.delimiter)>0){var d=a(':checkbox[name="'+b+'"]',f);a.each(c.split(g.delimiter),function(a,b){d.filter('[value="'+b+'"]').prop("checked",!0)})}else a(':radio[name="'+b+'"]',f).filter('[value="'+c+'"]').prop("checked",!0),a(':input[name="'+b+'"]',f).val(c),a(':input[value="'+b+'"]',f).val(c)})},a.p3=c}(jQuery,this),function(){function a(){}window.console||(window.console={});for(var b=["log","info","warn","error","debug","trace","dir","group","groupCollapsed","groupEnd","time","timeEnd","profile","profileEnd","dirxml","assert","count","markTimeline","timeStamp","clear"],c=0;c<b.length;c++)window.console[b[c]]||(window.console[b[c]]=a)}(),function(a,b,c){var d=a.p3||(a.p3={}),e="$.p3.form_tracking :: ",f="undefined"==typeof b._gaq?[]:b._gaq;d.form_tracking=function(b){f.length||console.warn(e+"Google Analytics not found");var d=a(b),g=d.is(":input")?d:a(":input",d),h=d.closest("form").attr("id");if(!h)throw new Error(e+"Form "+b+" not found, aborting");g.blur(function(){var b=a(this),d=b.attr("name");d!==c&&(g.val().length>0?f.push(["_trackEvent",h,"completed",d]):f.push(["_trackEvent",h,"skipped",d]))})}}(jQuery,this),function(a,b,c){var d=a.p3||{},e={el:"body",sizes:{threetwo:320,four:400,five:500,six:600,sixfive:650,seven:700,sevensome:768,eightfive:850,nine:900,tablet:480,desktop:1024,wide:1350,large:1600},onResize:!0,onLoad:!0,delay:100};d.narrow=function(d){function f(){return"number"==typeof b.innerWidth?b.innerWidth:c.documentElement&&c.documentElement.clientWidth?c.documentElement.clientWidth:void 0}function g(){var b="",c=f();a.each(i.sizes,function(a,d){c>=d?b+=" "+a:k.removeClass(a)}),k.addClass(b)}function h(a,b){l||(l=!0,setTimeout(function(){l=!1},b),a())}var i=a.extend(!0,e,d||{}),j=a(b),k=a(i.el),l=!1;i.onResize&&j.resize(function(){h(g,i.delay)}),i.onLoad&&j.ready(g)},a.p3=d}(jQuery,this,document),function(a,b,c,d){var e=a.p3||{},f={meterElement:".completed",textElement:"#action-counter-textual",fetchFrequency:3e4,updateSpeed:25,initialAnimationTotalDuration:2500,dataElement:"body",dataNamespace:"pledgeCounter",eventDriven:!1,fetchDataEvent:"fetchPledgeData",fetchCompleteEvent:"fetchPledgeDataComplete",jsonURL:"https://www.greenpeace.org/api/p3/pledge/config.json",params:{}};e.pledge_counter=function(e,g){var h=a.extend(!0,f,g||{}),i=a(h.meterElement,e),j=a(h.textElement,e),k=!1,l=0,m=0,n={count:0,target:0},o=a.p3.request(h.jsonURL),p=function(){if(k)return setTimeout(function(){p()},h.fetchFrequency),void 0;k=!0;var a=n.count;l>a&&(l=0),m=Math.ceil(a*h.updateSpeed/h.initialAnimationTotalDuration,0),0>=m&&(m=1),j.text(r(n.count)+" have joined so far. The target is "+r(n.target)+"."),q()},q=function(){if(l>=1*n.count)return k=!1,void 0;l+m<n.count?l+=m:l=n.count;var a=l/n.target*100;a>100&&(a=100),b.csstransforms?i.css({width:a+"%"}).html(r(l)+"&nbsp;"):i.animate({width:a+"%"},h.updateSpeed-5>=0?h.updateSpeed:0,function(){i.html(r(l)+"&nbsp;")}),setTimeout(q,h.updateSpeed)},r=function(a){for(var b=a+"",c=b.split("."),d=c[0],e=c.length>1?"."+c[1]:"",f=/(\d+)(\d{3})/;f.test(d);)d=d.replace(f,"$1,$2");return d+e},s=function(b){var c=d===b?a(h.dataElement).data(h.dataNamespace):b;if(!c||"error"===b.status||!c.pledges[0].action)throw console.log("ERROR"),a.each(b.errors,function(a,b){console.log(a+" => "+b)}),new Error("Errors in pledge data.");return n.count=c.pledges[0].action.count,n.target=c.pledges[0].action.target,isNaN(n.count)||isNaN(n.target)?(console.log("ERROR: progress data not found, aborting."),!1):(p(),void 0)},t=function(){var b=a.extend(!0,o.parameters,h.params);a.getJSON(o.url,b,function(a){s(a)}).error(function(){throw new Error('$.p3.pledge_counter :: Failed to load JSON from "'+o.url+'"')})};return b.load({test:c.JSON,nope:["dist/js/compat/json.min.js"],complete:function(){b.csstransforms&&i.css({"transition-duration":h.updateSpeed+"ms"}),h.eventDriven?(a(c).on(h.fetchDataEvent,function(){t()}),a(c).on(h.fetchCompleteEvent,function(){s()})):t()}}),{config:h,parseJSON:s,fetchJSON:t}},a.p3=e}(jQuery,Modernizr,this),function(a,b,c){var d=a.p3||{},e={emailField:"#UserEmail",identifyUserBy:"email",registrationFields:"#action-form-register",exceptionFields:"#action-form-message, #action-smallprints",signerCheckURL:"https://www.greenpeace.org/api/public/pledges/signercheck.json",validateForm:!0,validationRulesURL:"https://www.greenpeace.org/api/p3/pledge/config.json",animationDuration:350,disableOnError:!1,params:{},messageElement:'<div class="message"></div>'};a.expr[":"].p3_empty=function(b){var d=a(b);return d.attr("name")===c?!1:""===d.val()},d.pledge_with_email_only=function(f,g){var h=a.extend(!0,e,g||{}),i=a(f),j=i.is("form")?i:a("form",i),k=a(h.emailField),l=a("input[type=submit]",j),m=[],n=a.p3.request(h.signerCheckURL),o={url:n.url,parameters:a.extend(!0,n.parameters,h.params)},p=function(){if(o.parameters.page===c)throw new Error("Page identifier not found")},q=function(){switch(h.identifyUserBy){case"email":o.parameters.user=k.val();break;case"uuid":throw new Error("uuid not implemented");default:throw new Error("config.identifyUserBy: "+h.identifyUserBy+" invalid")}},r=function(){o.parameters.expire===c&&console.warn("$.p3.pledge_with_email_only :: No expiry date set")},s=function(b){l.prop("disabled","disabled").addClass("disabled"),m[b]={checked:!1},a.getJSON(o.url,o.parameters,function(c){m[b].checked=!0,l.removeProp("disabled").removeClass("disabled"),"success"===c.status?(console.log("$.p3.pledge_with_email_only :: signercheck API response success"),v(),t(b)):a.each(c.errors,function(b,d){switch(d.code){case 2:case 3:case 4:case 5:throw new Error("$.p3.pledge_with_email_only :: Invalid page: "+o.parameters.page);case 13:console.log("$.p3.pledge_with_email_only :: User has already signed this pledge");var e=k.parents(".email:first"),f=a(".message",e);f.length||(e.append(h.messageElement),f=a(".message",e)),f.append('<span class="error" for="'+k.attr("id")+'">'+d.pledge.unique+"</span>"),k.addClass("error");break;case 15:console.log("$.p3.pledge_with_email_only :: New user, show all fields"),w();break;case 16:console.warn("$.p3.pledge_with_email_only :: User exists, but is missing fields"),u(c.user);break;default:console.warn("Unhandled error code: "+d.code)}})}).fail(function(){if(h.disableOnError)throw new Error("$.p3.pledge_with_email_only.js :: Signer API request failed");console.warn("$.p3.pledge_with_email_only :: Failed to load JSON, all form inputs re-enabled"),w(),l.removeProp("disabled").removeClass("disabled")})},t=function(b){a(window).trigger("submit_"+b)},u=function(b){console.log("$.p3.pledge_with_email_only :: showMissingFields"),a.each(b,function(c){if(b[c]===!1){var d=a("div."+c,j),e=a(":input",d);e?(e.removeProp("disabled"),d.show(h.animationDuration)):console.warn("$.p3.pledge_with_email_only :: "+c+" not found")}})},v=function(){a(h.registrationFields+" > :not("+h.exceptionFields+", #action-submit-full)").hide().find(":input").prop("disabled","disabled")},w=function(){a(h.registrationFields+" > :not("+h.exceptionFields+", #action-submit-full)").show(h.animationDuration).find(":input").removeProp("disabled")},x=function(){v(),p(),r(),a(":input",j).keypress(function(b){return 13===b.which?(b.preventDefault(),a(this).blur(),l.focus().click(),!1):void 0}),l.click(function(b){q(),o.parameters.user?m[o.parameters.user]&&m[o.parameters.user].checked?a(window).trigger("submit_"+o.parameters.user):(b.preventDefault(),a(window).on("submit_"+o.parameters.user,function(){j.submit()}),s(o.parameters.user)):j.submit()}),h.validateForm&&a.p3.validation(j,{jsonURL:h.validationRulesURL,params:o.parameters,debug:!0,disableOnError:h.disableOnError,submitHandler:function(a){return j.valid()?(a.submit(),!0):void 0}})};b.load({test:window.JSON,nope:["dist/js/compat/json.min.js"],complete:x}),a.p3=d}}(jQuery,Modernizr),function(a,b,c,d){var e=a.p3||{},f={jsonURL:"https://www.greenpeace.org/api/p3/pledge/pledges.json",params:{},eventDriven:!1,fetchDataEvent:"fetchPledgeData",fetchCompleteEvent:"fetchPledgeDataComplete",updateInterval:5e3,userQueueInterval:750,maxUsers:8,maxRefreshes:30,countrySelector:"#UserCountry"};a.expr[":"].valueNoCase=function(b,c,d){var e=d[3];return e?a(b).prop("value").toLowerCase()===e.toLowerCase():!1},e.recent_signers=function(e,g){var h=a.extend(!0,f,g),i=a(e),j=!1,k=a.p3.request(h.jsonURL),l=[],m=!1,n=0,o={running:!1,delay:h.userQueueInterval,actions:[],callback:function(){},step:function(){if(o.actions.length)try{o.actions.pop()()}catch(a){console.log(a)}else o.running=!1},run:function(){o.running=!0,o.actions.length?(o.step(),setTimeout(o.run,o.delay)):(o.running=!1,o.callback())}},p=function(){if(o.running)return clearTimeout(m),m=setTimeout(function(){p()},h.updateInterval),!1;var b=a.extend(!0,k.parameters,h.params);a.getJSON(k.url,b,function(a){q(a)}).fail(function(){throw new Error('$.p3.recent_signers :: Failed to load JSON from "'+k.url+'"')})},q=function(b){var c=d===b?a(h.dataElement).data(h.dataNamespace):b;n++<h.maxRefreshes&&o.actions.push(function(){clearTimeout(m),m=setTimeout(function(){p()},h.updateInterval)}),a.each(c.pledges,function(a,b){return l[b.user.id]?!1:(l[b.user.id]=!0,b.user.dont_display_name===!0?!0:(o.actions.push(function(){t(b.user)}),void 0))}),o.actions.push(function(){u()}),o.run()},r=function(b){return b?a.timeago(b):void 0},s=function(b){return a(h.countrySelector+" option:valueNoCase("+b+")").text()},t=function(b){var c=a('<li style="display:none"><span class="since" data-since="'+b.created+'">'+r(b.created)+'</span><span class="icon flag '+b.country+'"></span><span class="name">'+b.firstname+" "+b.lastname+'</span><span class="country">'+s(b.country)+"</span></li>");j.prepend(c),c.show(350),h.maxUsers&&a("li",j).length>h.maxUsers&&a("li:last",j).hide(350).remove()},u=function(){a(".since",j).each(function(){var b=a(this);b.text(r(b.attr("data-since")))})};h.updateInterval<5e3&&(h.updateInterval=5e3),j=a("ul:first",i),j.length||(j=a("<ul></ul>"),i.append(j)),b.load({test:c.JSON,nope:["js/vendor/json.min.js"],complete:function(){h.eventDriven?(a(c).on(h.fetchDataEvent,function(){p()}),a(c).on(h.fetchCompleteEvent,function(){q()})):p()}})},a.p3=e}(jQuery,Modernizr,this),function(a,b){var c=a.p3||{},d={rememberMeSelector:"#RememberMe",emailSelector:"#UserEmail",cookieName:"email",expires:31,secure:"https"===window.location.protocol||"https"===document.location.protocol?!0:!1,keepRememberMeState:!0};c.remember_me_cookie=function(c,e){var f=a.extend(!0,d,e||{}),g=a(c).is("form")?a(c):a("form:first",c),h=a(f.rememberMeSelector,g).first(),i=a(f.emailSelector,g).first(),j=f.keepRememberMeState&&b.localstorage?!0:!1;a.cookie.defaults={expires:f.expires,secure:f.secure},i.val(a.cookie(f.cookieName)),g.submit(function(){h.is(":checked")?a.cookie(f.cookieName,i.val()):a.removeCookie(f.cookieName),j&&(localStorage.rememberMeGP=h.is(":checked")?"true":"false")}),j&&"undefined"!==localStorage.rememberMeGP&&h.prop("checked","true"===localStorage.rememberMeGP?!0:!1)},a.p3=c}(jQuery,Modernizr),function(a){var b=a.p3||{};b.request=function(a){var b={url:!1,parameters:!1},c=[],d=function(){var a={};return c[1]&&c[1].split(/[&;]/g).forEach(function(b){var c=b.split(/\=/);c.length>1&&c[0].length&&c[1].length&&(a[c[0]]=c[1])}),a},e=function(){return c[0].length?c[0]:a};return a?(c=a.split("?"),b.url=e(),b.parameters=d(),b):b},a.p3=b}(jQuery),function(a,b,c){var d=a.p3||{},e=function(){return(new Date).getTime()+" :: $.p3.social_sharing :: "}(),f={pageURL:!1,popup:{top:200,left:100,width:550,height:350},networks:{facebook:{enabled:!0,url:"http://www.facebook.com/sharer.php?u=__REFERRER__",count:0},twitter:{enabled:!0,url:"https://twitter.com/intent/tweet?original_referer=__REFERRER__&source=tweetbutton&text=__TITLE__&url=__REFERRER__&via=__ACCOUNT__",count:0,title:!1,account:"greenpeace"},google:{enabled:!0,url:"https://plus.google.com/share?url=__REFERRER__",count:0},linkedin:{enabled:!0,url:"https://www.linkedin.com/cws/share?url=__REFERRER__&original_referer=__REFERRER__",count:0},pinterest:{enabled:!0,url:"http://pinterest.com/pin/create/button/?url=__REFERRER__&media=__IMAGE__&description=__DESCRIPTION__",count:0,image:!1,description:!1}},precision:1,jsonURL:"https://www.greenpeace.org/api/p3/pledge/social.json"};d.social_sharing=function(d,g){function h(a){for(var b=a+"",c=b.split("."),d=c[0],e=c.length>1&&1*c[1]>0&&100>a?"."+c[1].replace(/0+$/,""):"",f=/(\d+)(\d{3})/;f.test(d);)d=d.replace(f,"$1,$2");return d+e}function i(a){if(a=1*a,1e4>a)return h(a);for(var b=["","K","M","G","T","P","E"],c=a,d=0;c>1e3;)c/=1e3,d++;return h(1*c.toFixed(k.precision))+b[d]}function j(){k.pageURL===!1&&(console.warn(e+'page referrer URL is not set, using "'+c.location.href+'"'),k.pageURL=c.location.href),a.each(k.networks,function(b,d){if(d.enabled!==!1){var f=a("li."+b,l),g=a(".counter span",f),h=a("a",f),j=d.url;switch(b){case"pinterest":d.image===!1&&(console.warn(e+"Pinterest sharing requires an image."),d.image=""),d.description===!1&&(console.warn(e+"Pinterest sharing requires a description."),d.description=""),j=j.replace("__IMAGE__",encodeURIComponent(d.image)),j=j.replace("__DESCRIPTION__",encodeURIComponent(d.description));break;case"twitter":d.title===!1&&(console.warn(e+"Twitter sharing requires a title."),d.title=""),j=j.replace("__TITLE__",encodeURIComponent(d.title)),j=j.replace("__ACCOUNT__",encodeURIComponent(d.account))}j=j.replace(/__REFERRER__/g,encodeURIComponent(k.pageURL)),h.attr({href:j,target:"_blank"}).click(function(a){a.preventDefault(),c.open(j,"Share this page","left="+k.popup.left+",top="+k.popup.top+",width="+k.popup.width+",height="+k.popup.height+",toolbar=0,resizable=1")}),g.text(i(d.count))}})}var k=a.extend(!0,f,g||{}),l=a(d);b.load({test:c.JSON,nope:["dist/js/compat/json.min.js"],complete:function(){a.getJSON(k.jsonURL,function(b){if(a.extend(!0,k,b),"success"!==b.status)throw console.warn(b),new Error(e+"Status: "+b.status+": server reported a problem");j()}).fail(function(){throw new Error(e+'Failed to load JSON: "'+k.jsonURL+'"')})}})},a.p3=d}(jQuery,Modernizr,this),function(a,b,c){var d=a.p3||{},e={jsonURL:"https://www.greenpeace.org/api/p3/pledges",rules:{},tests:{alphaPlus:"^[\\p{L}\\p{N}\\.\\-\\'\\,\\/]+$",numeric:"^\\p{N}+$",alpha:"^\\p{L}+$",url:"^((([A-Za-z]{3,9}:(?:\\/\\/)?)(?:[-;:&=\\+\\$,\\w]+@)?[A-Za-z0-9.-]+|(?:www.|[-;:&=\\+\\$,\\w]+@)[A-Za-z0-9.-]+)((?:\\/[\\+~%\\/.\\w-_]*)?\\??(?:[-\\+=&;%@.\\w_]*)#?(?:[\\w]*))?)$"},autoSign:!1,onfocusout:!1,onkeyup:!1,showSummary:!1,disableOnError:!1,errorElement:"span",errorPlacement:function(b,c){var d=a(c),e=d.prop("name");d.parents("."+e).first().find("div.message").html(b)},params:{},messageElement:'<div class="message"></div>'};a.validator.addMethod("valueNotEquals",function(a,b,c){return c!==a},"Value must not equal arg."),d.validation=function(d,f){var g=a.extend(!0,e,f||{}),h=a.p3.request(g.jsonURL),i={url:h.url,parameters:a.extend(!0,h.parameters,g.params)},j=a.p3.request(c.location.href).parameters,k=a(d),l=k.is("form")?k:a("form",d),m=g.messageElement,n=function(){a(":input",l).removeProp("disabled").removeClass("disabled")},o=function(){a(":input",l).prop("disabled","disabled").addClass("disabled")},p=function(){g.disableOnError&&o(),g.showSummary&&console.warn("$.p3.validation.js :: showSummary not yet implemented"),a.each(g.tests,function(b,c){try{a.validator.addMethod(b,function(a,b){var d=new XRegExp(c);return this.optional(b)||d.test(a)})}catch(d){}}),a(":input",l).each(function(){var b=a(this),c=b.prop("name"),d=c?b.parents("."+c).first():!1;d?d.find("div.message").length||d.append(m):b.is("[type=submit")||console.warn('$.p3.pledge_with_email_only :: "'+c+'" field parent not found')}),n(),l.validate(g),(g.autoSign||"true"===j.auto_sign||"1"===j.auto_sign)&&(a.p3.pledge_with_email_only?a("input[type=submit]",l).click():l.submit())};i.url?b.load({test:c.JSON,nope:["dist/js/compat/json.min.js"],complete:function(){a.getJSON(i.url,i.parameters,function(b){g=a.extend(!0,g,b)}).fail(function(){if(console.warn("$.p3.validation :: WARNING :: JSON failed to load from: "+g.jsonURL),g.disableOnError)throw o(),new Error("$.p3.validation :: Form input disabled");console.warn("$.p3.validation :: Attempting to continuing regardless...")}).complete(function(){p()})}}):p()},a.p3=d}(jQuery,Modernizr,this),function(a,b,c){var d={page:300507,key:"78d245e17c455859b4863ad34674f2b8",expire:"2013-11-02"},e="http://greenpeace.relephant.nl/international/en/api/v2/pledges/",f="json/signer_error_fields.json",g="json/rules_revised.json";a.ajaxSetup({cache:!1}),a(document).ready(function(){a("html").addClass((b.input.placeholder?"":"no-")+"placeholder"),b.mq("only all")||a.p3.narrow(),a.p3.form_tracking(".js-track-abandonment"),b.input.placeholder||a("#SearchText").focus(function(){var b=a(this);b.val()===b.attr("placeholder")&&(b.val(""),b.removeClass("placeholder"))}).blur(function(){var b=a(this);(""===b.val()||b.val()===b.attr("placeholder"))&&(b.addClass("placeholder"),b.val(b.attr("placeholder")))}).blur().parents("form").submit(function(){a(this).find("[placeholder]").each(function(){var b=a(this);b.val()===b.attr("placeholder")&&b.val("")})}),a("input[name=email]").focus(),a.p3.remember_me_cookie("#action-form"),a.p3.autofill("#action-form"),a.p3.pledge_counter("#action-counter",{jsonURL:e,params:d}),a.p3.pledge_with_email_only("#action-form",{signerCheckURL:f,validationRulesURL:g,params:d}),a.p3.social_sharing("#action-social-share",{jsonURL:"json/social_simple.json",networks:{twitter:{title:c.document.title},pinterest:{image:"http://www.greenpeace.org/international/Global/international/artwork/other/2010/openspace/bigspace-photo.jpg",description:c.document.title}}}),a.p3.recent_signers("#action-recent-signers",{jsonURL:e,params:d})})}(jQuery,Modernizr,this);